---
title: "PrePost"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{PrePost}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>", 
  eval = TRUE, 
  comment = FALSE,
  warning = FALSE,
  message = FALSE,
  error = FALSE,
  results = "hide"
)
```

## Background
The first question will be: analyse pre and post activity relative to what? This ‘index event’ could
arguably be anything – a GP attendance, an A+E visit, a 999 call, a particular point in time at
which some intervention was made. From experience, many managers and clinicians all around the
system have the same question: what happens before patients get to me, and what happens after? These
are valuable questions in order to understand the extent to which patients are using healthcare
services as intended, and to identify any interventions that could be made. For instance, if
multiple interactions are detected before some ‘index event’ of interest, then analysis could reveal
duplication and ‘bouncing around’. Analysis of post-event activity could reveal opportunities to
improve care at the event point, e.g. providing additional information to the patient to allay any
concerns that may otherwise lead them to seeking more healthcare afterwards. To date, we have
received requests from clinicians to evaluate activity pre and post events for children’s A+E
attendance, adult A+E head injury attendance, and hospital admission for heart attacks. The
purpose-built and reusable solution presented here can answer those questions, in a matter of
minutes, with very little analyst input.

## A scalable and reusable solution
Rather than conduct bespoke analysis each time we are asked question like these, there are benefits
to having a scalable and reusable solution, that can provide the required analysis at the touch of
the button. For the tool developed here, all the analyst will need to define is: 1. Sufficient
information to isolate the cohort of interest, via specification of the index event (ultimately, a
list of NHS numbers and index event times). 2. Coverage of the pre/post activity, in terms of the
time range (how many hours to search before/after the index event) and the care settings of interest
(e.g. GP attends, outpatient consultations, MSK community physio, 999 see/treat calls). The analyst
enters these inputs into an R script, which then automatically produces an MS Word document
containing the main results. Full results are also available from a number of separate files also
produced automatically by the script.

## Examples
Please see below for an example using synthetic data. Examples that can be run on the actual System
Wide Dataset can be found under the 'Articles' tab.

## Connecting to the database
First, generate the artificial data (sqlite files for each database), as follows:
```{r setup}
library(PrePost)

# generate example databases
prepost_example()
```

This will create a folder called gendata in your working directory, containing the database files
for the example cohort. Next, you can connect to this databases using:

```{r connect}
library(PrePost)
library(dplyr)
library(icdb)

# connect to ICB server using this
# srv <- icdb::server("[data_source_name]"])  #see ICDB documentation for details

# in this example we can connect to the synthetic data using
srv <- example_server()
```
## Define the cohort
Here an example cohort is provided on the example server. All we need is the
(pseudo) NHS number and the datetime of interest.
```{r cohort}
ids  <- srv$cohort$COHORT_SYNTH %>% select(nhs_number) %>% pull()
date <- srv$cohort$COHORT_SYNTH %>% select(index_event_time) %>% pull() %>% as.POSIXct()

```

## Define the activity filters
Here we must decide which healthcare activity we are interested in. We can define any number of filters to act on SWD activity columns, as a named list. The name of each filter will be used in the subsequent plots.
```{r activity_coverage}
activity_filter <- list(
  "A+E"                 = "pod_l1=='secondary' & pod_l2a=='ae'",
  "Community in-person" = "pod_l1=='community' & pod_l3=='physical'",
  "999"                 = "pod_l1=='999'",
  "111"                 = "pod_l1=='111'",
  "GP"                  = "pod_l1=='primary_care_contact'"
)
```

## Create the PrePost object
Next we create a PrePost object, defining the window of interest. If working on the ICB servers you
will need to pass the name of your ICB data source as the parameter `srv_name`. Please see the ICDB package documentation for instructions on how to setup the ICB data source. In this example we directly pass an example_server - this is purely for demonstration.
```{r prepost_obj}
obj <- PrePost(nhs_number       = ids,
               index_event_time = date,
               window_pre       = 31,
               window_post      = 30, 
               window_units     = "days",
               activity_filter  = activity_filter,
               svr              = example_server(), 
               svr_name         = NA_character_)
```

## Descriptives
Run the descriptive analysis
```{r descriptives, results='markup', fig.dim = c(7, 5)}
run_descriptives(obj)
```

## Activity analysis
Run the activity analysis
```{r activity_tables, results='markup', fig.dim = c(7, 5)}
run_activity_summary(obj, "before")
run_activity_summary(obj, "after")
```

## Theographs 
Generate the theographs
```{r generate_theographs, results='markup', fig.dim = c(7, 5)}
generate_theographs(obj)
```

## Activity volume
Analyse the activity volume
```{r activity_volume}
run_activity_volume(obj, "before")
run_activity_volume(obj, "after")
```

## Trace plots 
Generate the trace plots
```{r trace_plots, results='markup', fig.dim = c(7, 5)}
generate_trace_plots(obj, "before")
generate_trace_plots(obj, "before")
generate_trace_plots(obj, "around")
```
